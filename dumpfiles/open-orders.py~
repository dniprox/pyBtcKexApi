#!/usr/bin/env python2

import krakenex
import json


k = krakenex.API()
k.load_key('kraken.key')

query_string=[]

try:
    query_string=k.query_private('OpenPositions',{'pair':'XXBTZEUR'})
except:
    e = sys.exc_info()[0]
    print "Error doing a query public againts krakenex API"

def printJSONquery(json_string):
    print json.dumps(json_string, sort_keys=True, indent=4, separators=(',',': '))    

    
def printOpenPositions():

    sumVol = 0
    sumPriceVol = 0

    
    print "Open positions"
    print "--------------"
    def getOrderValue(order_code,string):
        return query_string["result"][order_code][string]

    for order_code in query_string["result"]:
        listKeys=["ordertype","pair","type","cost","fee","margin","vol"]
        listKeyValues=[]    
        for key in listKeys:
            listKeyValues.append([key,getOrderValue(order_code,key)])
        string_out=""
        for keyValue in listKeyValues:
            string_out+=keyValue[0]+":"+keyValue[1]+"|"

        cost = getOrderValue(order_code,"cost")
        vol  = getOrderValue(order_code,"vol")
        price = float(cost) / float(vol)
        string_out+=" price:"+str(price)
        print string_out

        sumPriceVol += float(price) * float(vol)
        sumVol += float(vol)

    return sumPriceVol,sumVol

#printJSONquery(query_string)
sumPriceVol,sumVol = printOpenPositions()

print "Average Price:", sumPriceVol / sumVol
print "Total Volume:", sumVol
